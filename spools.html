<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>spools with like remover</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    :root { --gap: 14px; }
    main { padding: 24px; max-width: 900px; margin: 0 auto; }
    h2 { margin: 0 0 8px; font-size: 22px; }
    .muted { color: #555; font-size: 14px; }
    .card { background: #fff; border: 1px solid #eee; box-shadow: 0 1px 2px rgba(0,0,0,0.04); border-radius: 12px; padding: 16px; margin-top: 16px; }
    .row { display: flex; gap: var(--gap); align-items: center; flex-wrap: wrap; }
    .col { display: grid; gap: 8px; }
    input[type="text"], button, select { font: inherit; padding: 10px 12px; border-radius: 10px; border: 1px solid #ddd; background: #fff; }
    input[type="checkbox"] { transform: scale(1.2); }
    button { cursor: pointer; }
    button.primary { background: #111; color: #fff; border-color: #111; }
    button:disabled { opacity: .6; cursor: not-allowed; }
    #log { white-space: pre-wrap; background: #0a0a0a; color: #d5ffd5; padding: 12px; border-radius: 10px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; max-height: 50vh; overflow: auto; }
    .pill { display: inline-block; padding: 4px 10px; border-radius: 999px; background: #f1f1f1; font-size: 12px; }
    .progress { height: 10px; background: #eee; border-radius: 999px; overflow: hidden; margin-top: 8px; }
    .progress > div { height: 100%; width: 0%; background: #111; transition: width .2s; }
    .grid { display: grid; grid-template-columns: 1fr; gap: var(--gap); }
    .config-note { font-size: 12px; color: #666; margin-top: 8px; }
    .config-note code { background: #f3f3f3; padding: 2px 6px; border-radius: 6px; }
  </style>
</head>
<body>
  <div class="container">
    <header class="blob-header">
      <h1>spools.</h1>
      <nav>
        <a href="index.html" class="blob-link home">home</a>
        <a href="about.html" class="blob-link about">about</a>
        <a href="spools.html" class="blob-link spools" data-active="true">spools</a>
      </nav>
    </header>
    <main>
      <h2>like remover</h2>
      <p class="muted">find a playlist, paste the URI, and this will make a new copy without songs you already liked.  since spotify changed their rules in may, u prolly will have to ask me to add u to the app for it to work.</p>

      <section class="card grid" id="auth-section">
        <div class="row">
          <div class="pill" id="auth-status">not signed in</div>
          <div id="user-pill" class="pill" style="display:none"></div>
        </div>
        <div class="row">
          <button id="login" class="primary">sign in with spotify</button>
          <button id="logout" style="display:none">sign out</button>
        </div>
        <div class="config-note">uses spotify web api (pkce)</div>
      </section>

      <section class="card grid">
        <div class="col">
          <label for="playlist-uri">playlist url/uri</label>
          <input id="playlist-uri" type="text" placeholder="e.g. spotify:playlist:37i9dQZF1DXcBWIGoYBM5M" />
        </div>
        <div class="row">
          <label><input id="refresh-cache" type="checkbox" /> refresh song cache</label>
          <button id="run" class="primary" disabled>remove likes</button>
        </div>
        <div class="progress"><div id="bar"></div></div>
        <div id="stats" class="row"></div>
      </section>

      <section class="card">
        <div id="log"></div>
      </section>
    </main>
  </div>

  <script>
    const CLIENT_ID = "b0969ab732d74d4b86f84ed01ac31199";
    const REDIRECT_URI = 'https://drewlefebvre.com/spools.html';
    const SCOPES = ['playlist-modify-public','playlist-modify-private','user-library-read'];

    const el = id => document.getElementById(id);
    const logEl = el('log');
    const barEl = el('bar');
    const statsEl = el('stats');

    function log(msg) {
      const time = new Date().toLocaleTimeString();
      logEl.textContent += `[${time}] ${msg}\n`;
      logEl.scrollTop = logEl.scrollHeight;
    }
    function setProgress(p) { barEl.style.width = `${Math.max(0, Math.min(100, p))}%`; }
    function parsePlaylistId(input) {
      if (!input) return null;
      try {
        if (input.startsWith('spotify:')) return input.split(':')[2];
        const url = new URL(input); const parts = url.pathname.split('/').filter(Boolean);
        if (parts[0]==='playlist') return parts[1];
      } catch {}
      return input;
    }

    const Storage = { set:(k,v)=>localStorage.setItem(k,JSON.stringify(v)), get:(k,d=null)=>{try{return JSON.parse(localStorage.getItem(k))??d}catch{return d}}, del:k=>localStorage.removeItem(k) };

    async function sha256(plain){const enc=new TextEncoder().encode(plain);const buf=await crypto.subtle.digest('SHA-256',enc);return new Uint8Array(buf)}
    function base64url(bytes){return btoa(String.fromCharCode(...bytes)).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'')}
    function randStr(len=64){const a=new Uint8Array(len);crypto.getRandomValues(a);return Array.from(a,b=>('0'+b.toString(16)).slice(-2)).join('')}

    const Auth={key:'sp_pkce_state',async login(){const state=randStr(16);const verifier=randStr(64);const challenge=base64url(await sha256(verifier));Storage.set(this.key,{state,verifier,clientId:CLIENT_ID,redirectUri:REDIRECT_URI});const url=new URL('https://accounts.spotify.com/authorize');url.searchParams.set('response_type','code');url.searchParams.set('client_id',CLIENT_ID);url.searchParams.set('redirect_uri',REDIRECT_URI);url.searchParams.set('scope',SCOPES.join(' '));url.searchParams.set('code_challenge_method','S256');url.searchParams.set('code_challenge',challenge);url.searchParams.set('state',state);window.location.assign(url.toString())},async complete(){const params=new URLSearchParams(window.location.search);const code=params.get('code');const state=params.get('state');const stored=Storage.get(this.key);if(!code||!stored||state!==stored.state)return null;window.history.replaceState({},document.title,window.location.pathname);const body=new URLSearchParams({grant_type:'authorization_code',code,redirect_uri:stored.redirectUri,client_id:stored.clientId,code_verifier:stored.verifier});const res=await fetch('https://accounts.spotify.com/api/token',{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body});if(!res.ok)throw new Error('Token exchange failed');const tok=await res.json();Storage.set('sp_tokens',{...tok,ts:Date.now(),clientId:stored.clientId,redirectUri:stored.redirectUri});Storage.del(this.key);return tok},async refreshIfNeeded(){const tok=Storage.get('sp_tokens');if(!tok)return null;const age=(Date.now()-(tok.ts||0))/1000;if(age<(tok.expires_in||3600)-60)return tok;if(!tok.refresh_token)return tok;const body=new URLSearchParams({grant_type:'refresh_token',refresh_token:tok.refresh_token,client_id:tok.clientId});const res=await fetch('https://accounts.spotify.com/api/token',{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body});if(!res.ok)return tok;const nt=await res.json();const merged={...tok,...nt,ts:Date.now()};Storage.set('sp_tokens',merged);return merged},logout(){Storage.del('sp_tokens')}};

    const API={async fetch(path,init={}){let tok=await Auth.refreshIfNeeded();if(!tok)throw new Error('Not authenticated');const res=await fetch(`https://api.spotify.com/v1${path}`,{...init,headers:{'Authorization':`Bearer ${tok.access_token}`,'Content-Type':'application/json',...(init.headers||{})}});if(res.status===401){Storage.del('sp_tokens');throw new Error('Session expired. Please sign in again.')};if(!res.ok){throw new Error(`API ${res.status}: ${await res.text()}`)};return res.json()},me(){return this.fetch('/me')},async getAllSavedTrackIds(onProgress){let items=[];let next='/me/tracks?limit=50';while(next){const data=await this.fetch(next.replace('https://api.spotify.com/v1',''));items.push(...data.items);onProgress?.(items.length);next=data.next};return items.filter(t=>t.track&&t.track.id).map(t=>t.track.id)},async getAllPlaylistTrackIds(pid,onProgress){let items=[];let next=`/playlists/${pid}/tracks?limit=100`;while(next){const data=await this.fetch(next.replace('https://api.spotify.com/v1',''));items.push(...data.items);onProgress?.(items.length);next=data.next};return items.filter(t=>t.track&&t.track.id).map(t=>t.track.id)},createPlaylist(uid,name,desc,pub=false){return this.fetch(`/users/${encodeURIComponent(uid)}/playlists`,{method:'POST',body:JSON.stringify({name,description:desc,public:pub})})},addTracks(pid,ids){const uris=ids.map(id=>`spotify:track:${id}`);return this.fetch(`/playlists/${pid}/tracks`,{method:'POST',body:JSON.stringify({uris})})},updateDetails(pid,details){return this.fetch(`/playlists/${pid}`,{method:'PUT',body:JSON.stringify(details)})}};

    const Cache={key:uid=>`sp_liked_cache_${uid}`,get:uid=>Storage.get(`sp_liked_cache_${uid}`),set:(uid,data)=>Storage.set(`sp_liked_cache_${uid}`,data)};

    let currentUser=null;
    async function ensureAuthedUI(){const toks=Storage.get('sp_tokens');const authed=!!toks?.access_token;el('auth-status').textContent=authed?'signed in':'not signed in';el('login').style.display=authed?'none':'';el('logout').style.display=authed?'':'none';el('run').disabled=!authed;if(authed){try{currentUser=await API.me();el('user-pill').style.display='';el('user-pill').textContent=`${currentUser.display_name||currentUser.id}`;statsEl.textContent=''}catch(e){log(`Auth check error: ${e.message}`)}}else{currentUser=null;el('user-pill').style.display='none'}}

    el('login').addEventListener('click',()=>Auth.login());
    el('logout').addEventListener('click',()=>{Auth.logout();ensureAuthedUI();log('signed out.')});

    async function maybeCompleteAuth(){try{const t=await Auth.complete();if(t)log('Authenticated with Spotify.')}catch(e){log(`Auth completion failed: ${e.message}`)}await ensureAuthedUI()}

    async function runTrimmer(){if(!currentUser){alert('sign in first');return};const playlistInput=el('playlist-uri').value.trim();const pid=parsePlaylistId(playlistInput);if(!pid){alert('enter a playlist URL/URI/ID.');return};setProgress(0);log('starting…');const useRefresh=el('refresh-cache').checked;let cache=Cache.get(currentUser.id);let likedIds=[];if(cache&&!useRefresh){likedIds=cache.ids||[];log(`loaded ${likedIds.length} liked tracks from cache.`)}else{log('fetching liked songs…');likedIds=await API.getAllSavedTrackIds(c=>{setProgress(Math.min(40,Math.floor(c/5))) });Cache.set(currentUser.id,{ids:likedIds,updatedAt:Date.now()});log(`cached ${likedIds.length} liked tracks.`)};log('fetching playlist tracks…');const plIds=await API.getAllPlaylistTrackIds(pid,c=>{setProgress(40+Math.min(30,Math.floor(c/3)))});log(`playlist contains ${plIds.length} tracks.`);const likedSet=new Set(likedIds);const filtered=plIds.filter(id=>!likedSet.has(id));const removed=plIds.length-filtered.length;statsEl.innerHTML=`<div class="pill">playlist: ${plIds.length}</div><div class="pill">liked: ${likedIds.length}</div><div class="pill">removed: ${removed}</div><div class="pill">remaining: ${filtered.length}</div>`;log(`tracks to keep: ${filtered.length}`);if(filtered.length===0){log('nothing to do.');setProgress(100);return};const t=new Date();const pad=n=>String(n).padStart(2,'0');const pname=`EXT:trim:${t.getFullYear()}-${pad(t.getMonth()+1)}-${pad(t.getDate())}-${pad(t.getHours())}${pad(t.getMinutes())}`;log(`creating new playlist: ${pname}`);const created=await API.createPlaylist(currentUser.id,pname,'',false);log(`created: ${created.external_urls?.spotify||created.id}`);log('adding tracks…');for(let i=0;i<filtered.length;i+=100){const batch=filtered.slice(i,i+100);await API.addTracks(created.id,batch);const done=Math.min(filtered.length,i+batch.length);setProgress(75+Math.floor(24*(done/filtered.length)));log(`added ${done}/${filtered.length}`)};const srcUri=playlistInput.startsWith('spotify:')?playlistInput:`spotify:playlist:${pid}`;const desc=`src::${srcUri} | archive_update::${useRefresh.toString().toUpperCase()} | cnt_removed::${removed}`;await API.updateDetails(created.id,{description:desc});log('description set.');setProgress(100);log('done.')}

    el('run').addEventListener('click',()=>{runTrimmer().catch(e=>log(`Error: ${e.message}`))});

    maybeCompleteAuth();
    ensureAuthedUI();
  </script>
</body>
</html>
